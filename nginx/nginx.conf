# NGINX Configuration for the Automation Challenge
# - Task 1: HTTP webserver
# - Task 2: HTTPS with TLS certificates
# - Bonus: FQDN-specific certificates using SNI

# ---------------------------
# HTTP SERVER (Port 80)
# ---------------------------
server {
    # Listen on IPv4 and IPv6 for HTTP traffic
    listen 80;
    listen [::]:80;

    # Accept requests for both local and FQDN hostnames
    server_name localhost automation-challenge.cgi.com;

    # Directory containing the static website content
    root /usr/share/nginx/html;
    index index.html;

    # Access and error logs (useful for debugging and auditing)
    access_log /var/log/nginx/access.log;
    error_log  /var/log/nginx/error.log;

    # Default location: serve files or return 404 if not found
    location / {
        try_files $uri $uri/ =404;
    }

    # Basic security headers (defensive defaults)
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Cache static assets to improve performance
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}

# ---------------------------
# HTTPS SERVER: localhost
# ---------------------------
server {
    # Enable HTTPS on port 443
    listen 443 ssl;
    listen [::]:443 ssl;

    # This server block only matches the hostname "localhost"
    server_name localhost;

    # TLS certificate and private key for localhost
    ssl_certificate     /etc/nginx/ssl/localhost.crt;
    ssl_certificate_key /etc/nginx/ssl/localhost.key;

    # Allow only modern and secure TLS versions
    ssl_protocols TLSv1.2 TLSv1.3;

    # Static content location (mounted via Docker volume)
    root /usr/share/nginx/html;
    index index.html;

    # Serve static files
    location / {
        try_files $uri $uri/ =404;
    }
}

# ---------------------------
# HTTPS SERVER: automation-challenge.cgi.com
# ---------------------------
server {
    # Enable HTTPS on port 443
    listen 443 ssl;
    listen [::]:443 ssl;

    # This server block matches the FQDN for Bonus I
    server_name automation-challenge.cgi.com;

    # FQDN-specific TLS certificate
    # Selected automatically by NGINX via SNI
    ssl_certificate     /etc/nginx/ssl/automation-challenge.crt;
    ssl_certificate_key /etc/nginx/ssl/automation-challenge.key;

    # Allow only modern and secure TLS versions
    ssl_protocols TLSv1.2 TLSv1.3;

    # Static content location
    root /usr/share/nginx/html;
    index index.html;

    # Serve static files
    location / {
        try_files $uri $uri/ =404;
    }
}
